name: Build and Deploy Nobelium Blog

on:
  push:
    branches:
      - main  # 每次 push main 分支都会触发部署

env:
  # Docker 镜像信息
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

  # Notion 数据
  NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

  # 项目页必须配置 BASE_PATH，保证资源路径正确
  BASE_PATH: "/nobelium/"
  BASE_URL: "https://MardeLuzLunar.github.io/nobelium/"

  # Pages branch
  DEPLOY_BRANCH: gh-pages

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ 拉取代码
      - uses: actions/checkout@v3

      # 2️⃣ 设置 Node.js
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # 3️⃣ 构建 Docker 镜像并传入 Notion secrets
      - name: Build Docker image
        run: |
          docker build \
            --build-arg NOTION_TOKEN=${{ secrets.NOTION_TOKEN }} \
            --build-arg NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }} \
            --build-arg BASE_PATH=${{ env.BASE_PATH }} \
            -t ${{ env.IMAGE_NAME }} .

      # 4️⃣ 推送 Docker 镜像到 GHCR（可选）
      - name: Push Docker image
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ${{ env.IMAGE_NAME }}

      # 5️⃣ 运行 Docker 构建博客并部署到 gh-pages
      - name: Build and Deploy site
  run: |
    docker run --rm \
      -e NOTION_TOKEN=${{ secrets.NOTION_TOKEN }} \
      -e NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }} \
      -e BASE_PATH=${{ env.BASE_PATH }} \
      -v ${{ github.workspace }}:/workspace \
      ${{ env.IMAGE_NAME }} \
      sh -c "cd /workspace && npm ci && npm run build && npm run deploy --branch main"

